<!DOCTYPE html>
<html>
  <head>
    <title>STQRY.js test suite</title>
  </head>
  <body>
    <div id="test-results"></div>
    <script src="./stqry.js"></script>
    <script type="text/javascript">
      var lastTestFailed = false
      function assert(statement) {
        if (!statement) {
          var err = new Error();
          lastTestFailed = true
          var stack = err.stack.split('\n')
          stack.shift()
          document.getElementById('test-results').innerHTML += "<font color='red'>False assertion</font>: <pre>" + stack.join('\n') + "</pre>"
          // TODO: stop running the test suite
        }
      }
      function finishTest(name, err, data) {
        if (err) {
          document.getElementById('test-results').innerHTML += "" + name + ": " + "<font color='red'>FAILED</font> (" + err.message + ")<br/>"
        }
        else {
          if (lastTestFailed) {
            document.getElementById('test-results').innerHTML += "" + name + ": " + "<font color='red'>FAILED</font> (False assertion)<br/>"
          }
          else {
            document.getElementById('test-results').innerHTML += "" + name + ": " + "<font color='green'>OK</font><br/>"
          }
        }
        lastTestFailed = false
      }
      function runTests(tests) {
        var test = tests.shift()
        var timeoutId = setTimeout(function () {
          finishTest(test.name, new Error('Timed out'), null)
          if (tests.length > 0) {
            runTests(tests)
          }
        }, 500)
        test(function (err, data) {
          clearTimeout(timeoutId)
          finishTest(test.name, err, data)
          if (tests.length > 0) {
            runTests(tests)
          }
        })
      }

      // should set 1 key, get 1 key
      function test_setGet(done) {
        window.stqry.storage.set({ "foo": "bar" }, function () {
          window.stqry.storage.get(["foo"], function (data) {
            assert(data)
            assert(Object.keys(data).length === 1)
            assert(data.foo === "bar")
            // clean up
            window.stqry.storage.remove(null, done)
          })
        })
      }
      // should set 1 key for customKey, get the right key for customKey
      function test_setGetCustomKey(done) {
        var customKeyBob = "bobs_dataset"
        var customKeyAlice = "alices_dataset"
        window.stqry.storage.set({ "foo": "bar_bob" }, function () {
          window.stqry.storage.set({ "foo": "bar_alice" }, function () {
            window.stqry.storage.get(["foo"], function (data) {
              assert(data)
              assert(Object.keys(data).length === 1)
              assert(data.foo === "bar_bob")
              window.stqry.storage.get(["foo"], function (data) {
                assert(data)
                assert(Object.keys(data).length === 1)
                assert(data.foo === "bar_alice")
                // clean up
                window.stqry.storage.remove(null, function () {
                  window.stqry.storage.remove(null, done, customKeyAlice)
                }, customKeyBob)
              }, customKeyAlice)
            }, customKeyBob)
          }, customKeyAlice)
        }, customKeyBob)
      }
      // should set 2 keys, get all keys
      function test_setGetAll(done) {
        window.stqry.storage.set({ "foo_1": "bar", "foo_2": "bar" }, function () {
          window.stqry.storage.get(null, function (data) {
            assert(data)
            assert(Object.keys(data).length === 2)
            assert(data.foo_1 === "bar")
            assert(data.foo_2 === "bar")
            // clean up
            window.stqry.storage.remove(null, done)
          })
        })
      }
      // should set 2 keys for customKey, get the right 2 keys for customKey
      function test_setGetAllCustomKey(done) {
        var customKeyBob = "bobs_dataset"
        var customKeyAlice = "alices_dataset"
        window.stqry.storage.set({ "foo_1": "bar_bob", "foo_2": "bar_bob" }, function () {
          window.stqry.storage.set({ "foo_1": "bar_alice", "foo_2": "bar_alice" }, function () {
            window.stqry.storage.get(null, function (data) {
              assert(data)
              assert(Object.keys(data).length === 2)
              assert(data.foo_1 === "bar_bob")
              assert(data.foo_2 === "bar_bob")
              // clean up
              window.stqry.storage.remove(null, function () {
                window.stqry.storage.remove(null, done, customKeyAlice)
              }, customKeyBob)
            }, customKeyBob)
          }, customKeyAlice)
        }, customKeyBob)
      }
      // should set 3 keys, remove 2 keys
      function test_removeFewKeys(done) {
        window.stqry.storage.set({ "foo_1": "bar", "foo_2": "bar", "foo_3": "bar" }, function () {
          window.stqry.storage.remove(["foo_1", "foo_2"], function () {
            window.stqry.storage.get(["foo_1", "foo_2", "foo_3"], function (data) {
              assert(data)
              assert(Object.keys(data).length === 1)
              assert(data.foo_3 === "bar")
              // clean up
              window.stqry.storage.remove(null, done)
            })
          })
        })
      }
      // should set 3 keys for customKey, remove the right 2 keys for customKey
      function test_removeFewKeysCustomKey(done) {
        var customKeyBob = "bobs_dataset"
        var customKeyAlice = "alices_dataset"
        window.stqry.storage.set({ "foo_1": "bar_bob", "foo_2": "bar_bob", "foo_3": "bar_bob" }, function () {
          window.stqry.storage.set({ "foo_1": "bar_alice", "foo_2": "bar_alice", "foo_3": "bar_alice" }, function () {
            window.stqry.storage.remove(["foo_1", "foo_2"], function () {
              window.stqry.storage.get(["foo_1", "foo_2", "foo_3"], function (data) {
                assert(data)
                assert(Object.keys(data).length === 1)
                assert(data.foo_3 === "bar_bob")
                window.stqry.storage.get(["foo_1", "foo_2", "foo_3"], function (data) {
                  assert(data)
                  assert(Object.keys(data).length === 3)
                  assert(data.foo_1 === "bar_alice")
                  assert(data.foo_2 === "bar_alice")
                  assert(data.foo_3 === "bar_alice")
                  // clean up
                  window.stqry.storage.remove(null, function () {
                    window.stqry.storage.remove(null, done, customKeyAlice)
                  }, customKeyBob)
                }, customKeyAlice)
              }, customKeyBob)
            }, customKeyBob)
          }, customKeyAlice)
        }, customKeyBob)
      }
      // should set 3 keys, remove all keys
      function test_removeAllKeys(done) {
        window.stqry.storage.set({ "foo_1": "bar", "foo_2": "bar", "foo_3": "bar" }, function () {
          window.stqry.storage.remove(null, function () {
            window.stqry.storage.get(["foo_1", "foo_2", "foo_3"], function (data) {
              assert(data)
              assert(Object.keys(data).length === 0)
              // finish
              done()
            })
          })
        })
      }
      // should set 3 keys for customKey, remove all keys for the right customKey
      function test_removeAllKeysCustomKey(done) {
        var customKeyBob = "bobs_dataset"
        var customKeyAlice = "alices_dataset"
        window.stqry.storage.set({ "foo_1": "bar_bob", "foo_2": "bar_bob", "foo_3": "bar_bob" }, function () {
          window.stqry.storage.set({ "foo_1": "bar_alice", "foo_2": "bar_alice", "foo_3": "bar_alice" }, function () {
            window.stqry.storage.remove(null, function () {
              window.stqry.storage.get(["foo_1", "foo_2", "foo_3"], function (data) {
                assert(data)
                assert(Object.keys(data).length === 0)
                window.stqry.storage.get(["foo_1", "foo_2", "foo_3"], function (data) {
                  assert(data)
                  assert(Object.keys(data).length === 3)
                  assert(data.foo_1 === "bar_alice")
                  assert(data.foo_2 === "bar_alice")
                  assert(data.foo_3 === "bar_alice")
                  // clean up
                  window.stqry.storage.remove(null, done, customKeyAlice)
                }, customKeyAlice)
              }, customKeyBob)
            }, customKeyBob)
          }, customKeyAlice)
        }, customKeyBob)
      }

      try {
        runTests([
          test_setGet,
          test_setGetCustomKey,
          test_setGetAll,
          test_setGetAllCustomKey,
          test_removeFewKeys,
          test_removeFewKeysCustomKey,
          test_removeAllKeys,
          test_removeAllKeysCustomKey,
        ])
      }
      catch (error) {
        console.error('General test suite error', error)
        alert('General test suite error:' + error.message)
        document.write('General test suite error:' + error.message)
      }

    </script>
  </body>
</html>
